1ï¸âƒ£ EC2 ì¸ìŠ¤í„´ìŠ¤ ì¤€ë¹„

ì¸ìŠ¤í„´ìŠ¤ ì¢…ë¥˜

Ubuntu Server 24.04 LTS

ìµœì†Œ ì‚¬ì–‘: t3.medium ì´ìƒ ê¶Œì¥ (2 vCPU, 4GB RAM)

ë³´ì•ˆ ê·¸ë£¹ ì„¤ì •

Kubernetes í†µì‹ ì„ ìœ„í•´ ì•„ë˜ í¬íŠ¸ í—ˆìš© í•„ìš”

í¬íŠ¸	ìš©ë„
6443	API Server
2379-2380	etcd
10250	Kubelet
10251	kube-scheduler
10252	kube-controller-manager
30000-32767	NodePort ì„œë¹„ìŠ¤

ICMP í—ˆìš© (Pingìš©)

í˜¸ìŠ¤íŠ¸ë„¤ì„ ì„¤ì •

sudo hostnamectl set-hostname master   # master ë…¸ë“œ
sudo hostnamectl set-hostname worker1  # worker ë…¸ë“œ
sudo hostnamectl set-hostname worker2  # worker ë…¸ë“œ


í˜¸ìŠ¤íŠ¸ íŒŒì¼ ìˆ˜ì •
/etc/hostsì— ë‚´ë¶€ IPì™€ í˜¸ìŠ¤íŠ¸ëª… ì¶”ê°€

10.0.0.10 master
10.0.0.11 worker1
10.0.0.12 worker2

Ubuntu 24.04 í™˜ê²½ì—ì„œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ê¸° ìœ„í•´ì„œëŠ” ê¸°ì¡´ì˜ `apt-key` ë°©ì‹ì´ ë” ì´ìƒ ì§€ì›ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ìƒˆë¡œìš´ GPG í‚¤ ê´€ë¦¬ ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤. 

# **EC2 3ëŒ€(Ubuntu 24.04) í™˜ê²½ì—ì„œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ëŠ” ëª…ë ¹ì–´ ëª¨ìŒ**

---

## ğŸ› ï¸ 1ë‹¨ê³„: ê³µí†µ ì´ˆê¸° ì„¤ì • (ëª¨ë“  ë…¸ë“œì—ì„œ ì‹¤í–‰)

```bash
# ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl wget vim apt-transport-https ca-certificates software-properties-common gnupg lsb-release

# swap ë¹„í™œì„±í™”
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab

# br_netfilter í™œì„±í™”
sudo modprobe br_netfilter
echo '1' | sudo tee /proc/sys/net/bridge/bridge-nf-call-iptables

# containerd ì„¤ì¹˜ ë° ì„¤ì •
sudo apt install -y containerd
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/^\s*SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
sudo systemctl restart containerd
sudo systemctl enable containerd

# Kubernetes GPG í‚¤ ë‹¤ìš´ë¡œë“œ ë° ì €ì¥
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/k8s.gpg

# Kubernetes ì €ì¥ì†Œ ì¶”ê°€
echo "deb [signed-by=/etc/apt/keyrings/k8s.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" | sudo tee /etc/apt/sources.list.d/k8s.list

# apt ì—…ë°ì´íŠ¸ ë° Kubernetes íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

---

ì§€ê¸ˆ EC2ëŠ” Ubuntu 24.04 ê¸°ë°˜ì´ê³ , containerd ì„¤ì¹˜ê¹Œì§€ ì™„ë£Œëœ ìƒíƒœ. í˜„ì¬ ìƒí™©ì—ì„œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ë ¤ë©´ `kubeadm`ì„ ì´ìš©í•´ì„œ ë§ˆìŠ¤í„° ë…¸ë“œë¥¼ ì´ˆê¸°í™”í•˜ê³  ì›Œì»¤ ë…¸ë“œë¥¼ ì—°ê²°í•˜ëŠ” ìˆœì„œë¡œ ì§„í–‰í•´ì•¼ í•œë‹¤. containerdë¥¼ CRIë¡œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ, kubeadm ì„¤ì •ì„ containerdì— ë§ê²Œ ì¡ì•„ì¤˜ì•¼ í•œë‹¤.

---

### 1ï¸âƒ£ í•„ìˆ˜ ì»¤ë„ ëª¨ë“ˆ ë° sysctl ì„¤ì •

```bash
# ë¸Œë¦¿ì§€ ë„¤íŠ¸ì›Œí¬ í•„í„°
sudo modprobe br_netfilter
echo '1' | sudo tee /proc/sys/net/bridge/bridge-nf-call-iptables

# sysctl ì ìš©
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

sudo sysctl --system
```

---

### 2ï¸âƒ£ kubeadm êµ¬ì„± íŒŒì¼ ë§Œë“¤ê¸°

containerdë¥¼ ì‚¬ìš©í•˜ë„ë¡ kubeadm config íŒŒì¼ ì‘ì„±:

```bash
sudo mkdir -p /etc/kubernetes
cat <<EOF | sudo tee /etc/kubernetes/kubeadm-config.yaml
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: v1.30.0
networking:
  podSubnet: "10.244.0.0/16"
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
nodeRegistration:
  criSocket: /run/containerd/containerd.sock
EOF
```

---

### 3ï¸âƒ£ ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™”

```bash
sudo kubeadm init --config=/etc/kubernetes/kubeadm-config.yaml --upload-certs
```

* ì´ˆê¸°í™” í›„ `kubeadm`ì´ ë³´ì—¬ì£¼ëŠ” `kubeadm join` ì»¤ë§¨ë“œê°€ ë‚˜ì¤‘ì— ì›Œì»¤ ë…¸ë“œ ì—°ê²°ì— í•„ìš”í•¨.
* ì´ˆê¸°í™”ê°€ ëë‚˜ë©´ í˜„ì¬ ì‚¬ìš©ìì— kubeconfig ë³µì‚¬:

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

---

### 4ï¸âƒ£ Pod ë„¤íŠ¸ì›Œí¬ ì„¤ì¹˜ (ì˜ˆ: Flannel)

```bash
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/v0.26.3/Documentation/kube-flannel.yml
```

* ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸(Calico ë“±)ë„ ê°€ëŠ¥. PodSubnetì€ kubeadm-config.yamlê³¼ ë™ì¼í•´ì•¼ í•¨.

---

### 5ï¸âƒ£ ì›Œì»¤ ë…¸ë“œ ì—°ê²°

ì›Œì»¤ ë…¸ë“œì—ì„œ:

```bash
sudo kubeadm join <MASTER_IP>:6443 --token <TOKEN> --discovery-token-ca-cert-hash sha256:<HASH>
```

* `<MASTER_IP>`ì™€ í† í°/í•´ì‹œ ê°’ì€ ë§ˆìŠ¤í„° ì´ˆê¸°í™” í›„ kubeadmì—ì„œ ì¶œë ¥ë¨.

---

### 6ï¸âƒ£ ìƒíƒœ í™•ì¸

ë§ˆìŠ¤í„°ì—ì„œ:

```bash
kubectl get nodes
kubectl get pods -A
```

---

âš ï¸ ì£¼ì˜ ì‚¬í•­

* EC2ì—ì„œ ë³´ì•ˆ ê·¸ë£¹ì— 6443, 10250, 2379\~2380, 8285, 8472 í¬íŠ¸ë¥¼ ì—´ì–´ì•¼ í•¨.
* Ubuntuì—ì„œ ì¬ë¶€íŒ… ì‹œ containerd, kubelet ì„œë¹„ìŠ¤ ìë™ ì‹œì‘ í™•ì¸ í•„ìš”:

```bash
sudo systemctl enable containerd kubelet
sudo systemctl start kubelet
```

---

![alt text](image.png)

sudo kubeadm join 172.31.46.22:6443 --token 9efvph.97gh1lhiau1e104q \
        --discovery-token-ca-cert-hash sha256:c7ce483a6fb1665a8806f67a0457c6795e94d67f00d97e14a41420ea7b224742 

```
[ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1
```

ì¦‰, **IPv4 í¬ì›Œë”©(ip\_forward)** ì´ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•Šë‹¤ëŠ” ëœ». KubernetesëŠ” Pod ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ ìœ„í•´ **IP í¬ì›Œë”©**ì´ ë°˜ë“œì‹œ ì¼œì ¸ ìˆì–´ì•¼ í•œë‹¤.

---

### í•´ê²° ë°©ë²•

1. **ì¼ì‹œì ìœ¼ë¡œ ì¼œê¸°**

```bash
sudo sysctl -w net.ipv4.ip_forward=1
```

> ì´ ë°©ë²•ì€ ì¬ë¶€íŒ…í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.

2. **ì˜êµ¬ì ìœ¼ë¡œ ì¼œê¸°**

```bash
sudo nano /etc/sysctl.conf
```

íŒŒì¼ì— ë‹¤ìŒ ë¼ì¸ ì¶”ê°€ ë˜ëŠ” ìˆ˜ì •:

```
net.ipv4.ip_forward=1
```

ë³€ê²½ ì ìš©:

```bash
sudo sysctl -p
```

3. **ê·¸ ë‹¤ìŒ ë‹¤ì‹œ join ì‹¤í–‰**

```bash
sudo kubeadm join 172.31.46.22:6443 --token 9efvph.97gh1lhiau1e104q \
        --discovery-token-ca-cert-hash sha256:c7ce483a6fb1665a8806f67a0457c6795e94d67f00d97e14a41420ea7b224742
```

---

ğŸ’¡ TIP:
ë§Œì•½ ë‹¤ë¥¸ preflight ì²´í¬ ë•Œë¬¸ì— ê³„ì† ë§‰íˆë©´, **ê°•ì œë¡œ ë¬´ì‹œ**í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```bash
sudo kubeadm join ... --ignore-preflight-errors=all
```

í•˜ì§€ë§Œ ê¶Œì¥í•˜ì§€ ì•Šê³ , í•„ìš”í•œ ì„¤ì •ì„ ë§ì¶˜ í›„ ì‹¤í–‰í•˜ëŠ” ê²Œ ì•ˆì •ì ì…ë‹ˆë‹¤.


# Master Node í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¶”ê°€

**kubeadm initì€ ì„±ê³µ**í–ˆëŠ”ë°, `kubectl` ëª…ë ¹ì´ ì œëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ” ë¬¸ì œ ë°œìƒ ì‹œ ì›ì¸ì€ **kubectlì´ ì‚¬ìš©í•  kubeconfigë¥¼ ì•„ì§ ì„¤ì •í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ì—†ì–´ì„œ API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŒ**

---

### ë¬¸ì œ ë¶„ì„

* `kubeadm init` ì¶œë ¥:

```
To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

* ì´í›„ `kubectl get node` ì‹¤í–‰í–ˆëŠ”ë°:

```
The connection to the server localhost:8080 was refused - did you specify the right host or port?
```

ì¦‰, kubectlì´ \*\*`/home/ubuntu/.kube/config`\*\*ë¥¼ ì½ì§€ ëª»í•˜ê³  **ê¸°ë³¸ localhost:8080**ì„ ì‹œë„í•˜ê³  ìˆëŠ” ìƒí™© ë°œìƒ

---

### í•´ê²° ë°©ë²•

1. **kubectlì´ ì‚¬ìš©í•  kubeconfig ë³µì‚¬**

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

2. **í™˜ê²½ ë³€ìˆ˜ë¡œ KUBECONFIG ì§€ì •** (ì„ íƒ ì‚¬í•­)

```bash
export KUBECONFIG=$HOME/.kube/config
```

* ì´ë ‡ê²Œ í•˜ë©´ í•´ë‹¹ ì„¸ì…˜ì—ì„œ kubectlì´ ì˜¬ë°”ë¥¸ kubeconfigë¥¼ ì‚¬ìš©í•œë‹¤.

3. **kubectl ìƒíƒœ í™•ì¸**

```bash
kubectl get nodes
```

* ì´ì œ control-plane ë…¸ë“œê°€ `Ready` ìƒíƒœë¡œ ë‚˜ì™€ì•¼ í•œë‹¤.

---

ğŸ’¡ TIP:

* ë§Œì•½ root ê³„ì •ì—ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œë‹¤ë©´:

```bash
export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl get nodes
```

* \*\*Pod ë„¤íŠ¸ì›Œí¬(CNI)\*\*ê°€ ì•„ì§ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ, Flannelì´ë‚˜ Calicoë¥¼ ì ìš©í•´ì•¼ ë‹¤ë¥¸ ë…¸ë“œë“¤ì´ Join ê°€ëŠ¥í•˜ë‹¤.

---

---

## 1ï¸âƒ£ CNI ì„¤ì¹˜ëŠ” **ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œë§Œ ëª…ë ¹ ì‹¤í–‰**

* **ì™œ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œë§Œ?**

  * kubeadmìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ë©´, **Control Planeì´ cluster-wide APIë¥¼ ê´€ë¦¬**í•œë‹¤.
  * CNI YAML(manifest)ì„ `kubectl apply -f ...`ë¡œ ì„¤ì¹˜í•˜ë©´, **API ì„œë²„ê°€ ëª¨ë“  Nodeì— DaemonSetì„ ë°°í¬**í•œë‹¤.
  * ì¦‰, **Worker Nodeë“¤ì— ë³„ë„ë¡œ ì„¤ì¹˜í•  í•„ìš” ì—†ìŒ** â†’ ë§ˆìŠ¤í„°ì—ì„œ í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ë©´ ë¨.

* **ì‹¤í–‰ ì›ë¦¬**

  1. Flannel YAMLì—ëŠ” DaemonSetì´ í¬í•¨ë¼ ìˆë‹¤.
  2. DaemonSetì´ ê° Nodeì— Podë¥¼ ìë™ ìƒì„±í•œë‹¤.
  3. kubeletì´ CNI pluginì„ ì´ˆê¸°í™”í•˜ë©´ì„œ Node ìƒíƒœê°€ `Ready`ë¡œ ë³€í•œë‹¤.

---

## 2ï¸âƒ£ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´

```bash
# 1. Flannel CNI ì„¤ì¹˜
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml

# 2. ì„¤ì¹˜ ìƒíƒœ í™•ì¸
kubectl get pods -n kube-system

# 3. Node ìƒíƒœ í™•ì¸
kubectl get nodes
```

  * `coredns` Podê°€ Runningìœ¼ë¡œ ë°”ë€Œê³ 
  * ëª¨ë“  Nodeê°€ `Ready` ìƒíƒœë¡œ ë³€í•˜ë©°
  * ì•± Podë„ Pendingì—ì„œ Runningìœ¼ë¡œ ì „í™˜ëœë‹¤.

---

## 3ï¸âƒ£ ë©€í‹° Node ì£¼ì˜ ì‚¬í•­

* ë§ˆìŠ¤í„° ë…¸ë“œì˜ `Taints` ë•Œë¬¸ì— ì¼ë°˜ ì•± PodëŠ” ìŠ¤ì¼€ì¤„ë§ ì•ˆ ë¨:

```
Taints: node-role.kubernetes.io/control-plane:NoSchedule
```

* ì•±ì„ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì‹¤í–‰í•˜ê³  ì‹¶ìœ¼ë©´ **Podì— toleration** ì¶”ê°€ í•„ìš”.
* Worker Nodeì—ëŠ” taint ì—†ìœ¼ë¯€ë¡œ ë°”ë¡œ ìŠ¤ì¼€ì¤„ë§ ê°€ëŠ¥.

---

ğŸ’¡ ê²°ë¡ :

* **ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œë§Œ Flannel ì„¤ì¹˜**í•˜ë©´ ëª¨ë“  Nodeê°€ ìë™ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸ ì ìš©ë¨
* Node Ready â†’ CoreDNS Running â†’ ì•± Pod Scheduling ìˆœì„œë¡œ ì •ìƒí™”

---

- NodePort ì„¤ì •

kubectl patch svc gift-app-svc -p '{"spec":{"type":"NodePort"}}'
